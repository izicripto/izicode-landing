<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Projeto - Izicode Edu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="/js/auth-guard.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' } }
                }
            }
        }
    </script>
    <style>
        /* Typography for rendered markdown */
        .prose h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: #0f172a;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .prose h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .prose h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #334155;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .prose p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: #475569;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .prose li {
            margin-bottom: 0.5rem;
        }

        .prose code {
            background-color: #f1f5f9;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
            color: #0f172a;
        }

        .prose pre {
            background-color: #1e293b;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        .prose pre code {
            background-color: transparent;
            color: #e2e8f0;
            padding: 0;
        }

        .prose strong {
            color: #0f172a;
            font-weight: 700;
        }

        .prose blockquote {
            border-left: 4px solid #0ea5e9;
            padding-left: 1rem;
            font-style: italic;
            color: #64748b;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">

    <!-- Navbar -->
    <nav class="sticky top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="library.html"
                    class="flex items-center gap-2 text-slate-600 hover:text-brand-600 transition-colors group">
                    <svg class="w-5 h-5 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    <span class="font-medium">Voltar para Biblioteca</span>
                </a>

                <div class="flex items-center gap-3">
                    <button id="startProjectBtn"
                        class="bg-brand-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-brand-600 transition-all shadow-lg flex items-center gap-2 group hidden">
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Começar Projeto
                    </button>
                    <button id="quizBtn" onclick="goToQuiz()"
                        class="bg-white border-2 border-brand-100 text-brand-600 px-4 py-2 rounded-lg font-bold hover:bg-brand-50 transition-all flex items-center gap-2 group">
                        <svg class="w-5 h-5 group-hover:rotate-12 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                        </svg>
                        Testar Conhecimento
                    </button>
                    <button onclick="exportToPDF()"
                        class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-medium hover:bg-slate-200 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        PDF
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header Hero -->
    <header class="bg-white border-b border-slate-200 relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-brand-50 to-white opacity-50"></div>
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 relative">
            <div class="flex flex-wrap gap-3 mb-4">
                <span id="projectTool"
                    class="px-3 py-1 bg-brand-100 text-brand-700 text-xs font-bold rounded-full uppercase tracking-wide">Ferramenta</span>
                <span id="projectDiff"
                    class="px-3 py-1 bg-slate-100 text-slate-700 text-xs font-bold rounded-full uppercase tracking-wide">Dificuldade</span>
                <span id="projectTime"
                    class="px-3 py-1 bg-slate-100 text-slate-700 text-xs font-bold rounded-full uppercase tracking-wide flex items-center gap-1">
                    <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Duração</span>
            </div>

            <h1 id="projectTitle"
                class="font-display text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">Título do
                Projeto</h1>
            <p id="projectDesc" class="text-xl text-slate-600 leading-relaxed max-w-2xl">Descrição curta do projeto
                explicando o objetivo principal e o que os alunos vão aprender.</p>

            <div class="mt-8 flex flex-wrap gap-6 text-sm text-slate-500 border-t border-slate-100 pt-6">
                <div>
                    <span class="block font-bold text-slate-900 mb-1">BNCC</span>
                    <span id="projectBNCC" class="bg-slate-100 px-2 py-1 rounded">EF00TEC00</span>
                </div>
                <div>
                    <span class="block font-bold text-slate-900 mb-1">ODS (ONU)</span>
                    <span id="projectODS" class="bg-slate-100 px-2 py-1 rounded">ODS X</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <article id="projectContent"
            class="bg-white p-8 md:p-12 rounded-3xl shadow-sm border border-slate-200 prose prose-slate max-w-none">
            <!-- Content rendered from Markdown -->
            <div class="animate-pulse space-y-4">
                <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                <div class="h-4 bg-slate-200 rounded"></div>
                <div class="h-4 bg-slate-200 rounded"></div>
                <div class="h-4 bg-slate-200 rounded w-1/2"></div>
            </div>
        </article>

        <!-- Project Submission & Completion Section -->
        <section id="submissionSection" class="mt-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200 hidden">
            <div class="flex items-center justify-between cursor-pointer group"
                onclick="document.getElementById('uploadWrapper').classList.toggle('hidden')">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-green-600 shadow-sm border border-green-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-display font-bold text-xl text-slate-800">Concluir Atividade</h2>
                        <p class="text-sm text-slate-500">Já terminou? Envie sua foto aqui!</p>
                    </div>
                </div>
                <div class="text-slate-400 group-hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>

            <div id="uploadWrapper" class="mt-6 pt-6 border-t border-slate-100 hidden">
                <div id="uploadContainer"
                    class="border-2 border-dashed border-slate-200 rounded-2xl p-8 flex flex-col items-center justify-center bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer group relative overflow-hidden">
                    <input type="file" id="photoInput" class="absolute inset-0 opacity-0 cursor-pointer"
                        accept="image/*">

                    <div id="uploadPlaceholder" class="flex flex-col items-center">
                        <div
                            class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-brand-500 transition-colors mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <span class="font-bold text-slate-600">Escolhar ou Tirar Foto</span>
                        <span class="text-xs text-slate-400">JPG, PNG (Máx 5MB)</span>
                    </div>

                    <div id="previewContainer" class="hidden w-full flex flex-col items-center">
                        <img id="photoPreview"
                            class="max-h-64 rounded-xl shadow-md mb-4 object-cover border-4 border-white">
                        <div class="w-full mb-4">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Observações / Reflexão:</label>
                            <textarea id="projectNotes" rows="3"
                                class="w-full rounded-xl border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500"
                                placeholder="O que você aprendeu com este projeto? Teve alguma dificuldade?"></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button id="cancelUpload"
                                class="px-4 py-2 text-sm font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors">Remover</button>
                            <button id="confirmUpload"
                                class="bg-brand-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-brand-600 transition-all flex items-center gap-2">
                                <span>Enviar Projeto</span>
                                <div id="uploadSpinner"
                                    class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div id="completionSuccess" class="hidden text-center py-6">
                    <div
                        class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-green-200">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="font-display font-bold text-2xl text-slate-800">Parabéns!</h3>
                    <p class="text-slate-500 mb-6">Seu projeto foi concluído com sucesso e você ganhou **50 XP**!</p>
                    <a href="student-area.html"
                        class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-900 transition-all">Voltar
                        ao Meu Painel</a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-400">Izicode Edu © 2026. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/js/pdf-generator.js"></script>

    <script type="module">
        import { getProjectById } from './js/projects-data.js';
        import { auth, db, storage, doc, getDoc, setDoc, updateDoc, serverTimestamp, increment, ref, uploadBytes, getDownloadURL } from './js/firebase-config.js';

        // Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const staticProjectId = params.get('id');
        const userProjectId = params.get('userProject');
        const libraryProjectId = params.get('libraryId');

        // DOM Elements
        const startBtn = document.getElementById('startProjectBtn');
        const submissionSection = document.getElementById('submissionSection');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const previewContainer = document.getElementById('previewContainer');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const confirmUpload = document.getElementById('confirmUpload');
        const cancelUpload = document.getElementById('cancelUpload');
        const projectNotes = document.getElementById('projectNotes');

        let project = null; // Will hold the project data object

        // Global quiz navigation function
        window.goToQuiz = function () {
            let url = 'quiz-arena.html?';
            if (staticProjectId) url += 'projectId=' + staticProjectId;
            else if (userProjectId) url += 'userProjectId=' + userProjectId;
            else if (libraryProjectId) url += 'libraryProjectId=' + libraryProjectId;
            window.location.href = url;
        };

        async function loadProject() {
            if (staticProjectId) {
                // Scenario 1: Static Library Project
                project = getProjectById(staticProjectId);
                renderProject(project);
                initInteraction(project.id, false);
            } else if (userProjectId) {
                // Scenario 2: User AI Project (Firestore)
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const docRef = doc(db, `users/${user.uid}/projects/${userProjectId}`);
                            const docSnap = await getDoc(docRef);

                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                // Adapt Firestore data to Page format
                                project = {
                                    id: docSnap.id,
                                    title: data.title,
                                    description: "Projeto personalizado criado com IA",
                                    content: data.content,
                                    tools: data.techs || [data.type === 'ai-lesson-plan' ? 'IA Generativa' : 'Manual'],
                                    difficulty: "Adaptável",
                                    duration: "Flexível",
                                    bncc: data.bncc ? data.bncc.split(',') : [],
                                    ods: "Educação de Qualidade",
                                    isUserProject: true
                                };
                                renderProject(project);
                                // For user projects, "Start" is implied or we can just show edit modes later.
                                // For now, we reuse the submission logic if they want to 'complete' it.
                                initInteraction(docSnap.id, true);
                            } else {
                                renderNotFound();
                            }
                        } catch (error) {
                            console.error("Erro ao carregar projeto do usuário:", error);
                            renderNotFound();
                        }
                    } else {
                        // Needs auth
                        window.location.href = `index.html?redirect=${encodeURIComponent(window.location.href)}`;
                    }
                });
            } else if (libraryProjectId) {
                // Scenario 3: Community Library Project
                try {
                    const docRef = doc(db, "library", libraryProjectId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        project = {
                            id: docSnap.id,
                            title: data.title,
                            description: "Projeto da Comunidade por " + (data.authorName || "Professor"),
                            content: data.content,
                            tools: data.techs || [data.type === 'ai-lesson-plan' ? 'IA Generativa' : 'Manual'],
                            difficulty: "Comunidade",
                            duration: data.grade || "Flexível",
                            bncc: data.bncc ? data.bncc.split(',') : [],
                            ods: "Educação de Qualidade",
                            isUserProject: false, // Treat as public/static for interaction
                            isCommunity: true
                        };
                        renderProject(project);
                        initInteraction(docSnap.id, false);
                    } else {
                        renderNotFound();
                    }
                } catch (error) {
                    console.error("Erro ao carregar projeto da biblioteca:", error);
                    renderNotFound();
                }
            } else {
                renderNotFound();
            }
        }

        function renderProject(data) {
            document.getElementById('projectTitle').textContent = data.title;
            document.title = `${data.title} - Izicode Edu`;
            document.getElementById('projectDesc').textContent = data.description;
            document.getElementById('projectTool').textContent = data.tools[0] || 'Geral';
            document.getElementById('projectDiff').textContent = data.difficulty;
            document.getElementById('projectTime').innerHTML = `
                <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ${data.duration}
            `;

            document.getElementById('projectBNCC').textContent = Array.isArray(data.bncc) ? data.bncc.join(', ') : (data.bncc || 'Geral');
            document.getElementById('projectODS').textContent = data.ods || 'Geral';

            // Render Markdown Content
            document.getElementById('projectContent').innerHTML = marked.parse(data.content);
        }

        function renderNotFound() {
            document.querySelector('main').innerHTML = `
                <div class="text-center py-20">
                    <div class="mb-4 flex justify-center text-slate-300">
                        <svg class="w-20 h-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Projeto não encontrado</h2>
                    <a href="library.html" class="text-brand-600 hover:underline mt-4 block">Voltar para Biblioteca</a>
                </div>
            `;
        }

        async function initInteraction(pid, isUserProject) {
            // Re-bind interaction logic but checking auth first if needed
            // This reuses the existing auth check logic or simplifies it

            // For User Projects, we already checked auth.
            // For Static, we assume public UNTIL interaction.

            if (isUserProject) {
                // User projects are "Started" by definition of creation? 
                // Or maybe we treat them as reference docs.
                // Let's allow photo upload too.
                startBtn.classList.add('hidden'); // Logic handled in load
            }

            // Keep original auth listener for the Submission Logic
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const projectRef = doc(db, "users", user.uid, "projects", pid);
                    // For user projects, this is the SAME doc. Be careful not to overwrite 'content'.
                    // The original code uses `users/{uid}/projects/{staticId}`.
                    // For USER created projects, the ID IS the doc ID.

                    const projectSnap = await getDoc(projectRef);

                    if (projectSnap.exists()) {
                        const data = projectSnap.data();

                        // If it's a User Project, the doc exists (we just read it).
                        // We check 'progress' field.
                        if (data.progress === 100) {
                            renderCompletedState(data.photoUrl, data.notes);
                        } else {
                            if (!isUserProject) {
                                // Only show 'Continue' for static projects that were started
                                startBtn.classList.remove('hidden');
                                startBtn.innerHTML = `
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    Continuar Projeto
                                `;
                                startBtn.classList.replace('bg-brand-500', 'bg-slate-800');
                            }
                            submissionSection.classList.remove('hidden');
                        }
                    } else {
                        // Not started yet (Static only)
                        if (!isUserProject) startBtn.classList.remove('hidden');
                    }

                    startBtn.onclick = async () => {
                        // Only for static projects to "Start" them
                        try {
                            startBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>';
                            startBtn.disabled = true;

                            await setDoc(projectRef, {
                                title: project.title,
                                lastAccess: serverTimestamp(),
                                progress: 0,
                                startedAt: serverTimestamp()
                            }, { merge: true });

                            window.location.reload();
                        } catch (error) {
                            console.error("Error starting:", error);
                        }
                    };

                    // Copy existing photo upload logic...
                    setupUpload(user, pid, projectRef);
                }
            });
        }

        function setupUpload(user, pid, projectRef) {
            // Re-attach listeners utilizing closure variables
            photoInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (re) => {
                        photoPreview.src = re.target.result;
                        uploadPlaceholder.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };

            cancelUpload.onclick = () => {
                photoInput.value = "";
                uploadPlaceholder.classList.remove('hidden');
                previewContainer.classList.add('hidden');
            };

            confirmUpload.onclick = async () => {
                const file = photoInput.files[0];
                const notes = projectNotes ? projectNotes.value : '';
                if (!file) return;

                try {
                    document.getElementById('uploadSpinner').classList.remove('hidden');
                    confirmUpload.disabled = true;

                    const storageRef = ref(storage, `completions/${user.uid}/${pid}_${Date.now()}.jpg`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    await setDoc(projectRef, {
                        progress: 100,
                        photoUrl: downloadURL,
                        notes: notes,
                        completedAt: serverTimestamp(),
                        lastAccess: serverTimestamp()
                    }, { merge: true });

                    const userRef = doc(db, "users", user.uid);
                    await updateDoc(userRef, { xp: increment(50) });

                    renderCompletedState(downloadURL);
                    triggerConfetti();
                } catch (error) {
                    console.error("Upload error:", error);
                    alert("Houve um erro ao enviar sua foto. Tente novamente!");
                    confirmUpload.disabled = false;
                    document.getElementById('uploadSpinner').classList.add('hidden');
                }
            };
        }

        // Initialize
        loadProject();

        // Export PDF Function
        window.exportToPDF = function () {
            if (!project) return;
            const tempContainer = document.createElement('div');
            tempContainer.id = 'print-temp';
            tempContainer.style.background = 'white';
            tempContainer.style.padding = '40px';
            tempContainer.style.width = '800px';

            tempContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0284c7; padding-bottom: 20px;">
                    <h1 style="color: #0284c7; font-size: 28px; font-weight: bold; margin: 0;">${project.title}</h1>
                    <div style="color: #64748b; font-size: 14px; margin-top: 10px;">
                        <span>${project.tools[0]}</span> • <span>${project.grade}</span> • <span>${project.duration}</span>
                    </div>
                </div>
                <div class="prose" style="font-family: sans-serif; color: #334155;">
                    ${marked.parse(project.content)}
                </div>
                <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                    Gerado por Izicode Edu Library • www.izicode.com.br
                </div>
             `;

            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);

            pdfGenerator.htmlToPDF('print-temp', `projeto-${project.id}.pdf`)
                .finally(() => {
                    document.body.removeChild(tempContainer);
                });
        };
    </script>
</body>

</html>