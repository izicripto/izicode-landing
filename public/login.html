<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Izicode Edu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 500: '#0ea5e9', 600: '#0284c7' } }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 3px solid #e0f2fe;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.6s linear infinite;
        }
    </style>
</head>

<body class="bg-white min-h-screen flex flex-col md:flex-row">

    <!-- Metade Azul Claro (Visual/Branding) -->
    <div class="hidden md:flex md:w-1/2 bg-brand-100 items-center justify-center p-12">
        <div class="max-w-md text-center">
            <img src="images/logo.png" alt="Izicode Logo" class="w-32 h-32 mx-auto mb-8">
            <h1 class="font-display text-4xl font-bold text-slate-900 mb-4">Bem-vindo à Revolução Maker</h1>
            <p class="text-slate-600 text-lg">Acesse as ferramentas que vão transformar a educação na sua escola.</p>
        </div>
    </div>

    <!-- Metade Login (Branco) -->
    <div class="w-full md:w-1/2 flex items-center justify-center p-8 bg-white">
        <div class="max-w-sm w-full">
            <div class="md:hidden text-center mb-8">
                <img src="images/logo.png" alt="Izicode Logo" class="w-20 h-20 mx-auto mb-4">
                <h2 class="font-display text-2xl font-bold text-slate-900">Izicode Edu</h2>
            </div>

            <div class="text-left mb-10">
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Entrar na Plataforma</h2>
                <p class="text-slate-500">Use sua conta institucional ou pessoal do Google.</p>
            </div>

            <button id="googleLoginBtn"
                class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 py-3.5 px-4 rounded-xl font-bold text-slate-700 hover:bg-slate-50 hover:border-brand-300 transition-all shadow-sm">
                <svg id="googleIcon" class="w-6 h-6" viewBox="0 0 48 48">
                    <path fill="#EA4335"
                        d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z">
                    </path>
                    <path fill="#4285F4"
                        d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z">
                    </path>
                    <path fill="#FBBC05"
                        d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z">
                    </path>
                    <path fill="#34A853"
                        d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z">
                    </path>
                </svg>
                <span id="btnText">Entrar com Google</span>
                <div id="spinner" class="spinner hidden"></div>
            </button>

            <div class="mt-8 text-center">
                <a href="index.html" class="text-slate-400 text-sm hover:text-brand-600 transition-colors">← Voltar para
                    o site</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, provider, signInWithPopup, db, doc, setDoc, getDoc } from './js/firebase-config.js';

        const btn = document.getElementById('googleLoginBtn');
        const btnText = document.getElementById('btnText');
        const googleIcon = document.getElementById('googleIcon');
        const spinner = document.getElementById('spinner');

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            btnText.textContent = 'Conectando...';
            googleIcon.classList.add('hidden');
            spinner.classList.remove('hidden');

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                btnText.textContent = 'Verificando permissão...';

                // 1. Verificar se usuário já existe e está aprovado na coleção principal
                const userDocRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userDocRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    if (userData.status === 'approved' || userData.role === 'admin' || userData.role === 'teacher') {
                        // ACESSO LIBERADO
                        console.log("Acesso permitido:", userData.role);
                        window.location.href = "dashboard.html";
                        return;
                    }
                }

                // 2. Se não tem acesso, salvar como Lead/Espera
                const leadRef = doc(db, "extreme_clients", user.uid);
                await setDoc(leadRef, {
                    uid: user.uid,
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    status: "waiting_list",
                    lastLogin: new Date(),
                    provider: "google"
                }, { merge: true });

                btnText.textContent = 'Redirecionando para espera...';
                setTimeout(() => {
                    window.location.href = "platform-dev.html";
                }, 500);
            } catch (error) {
                console.error(error);
                alert("Erro ao autenticar: " + error.message);
                btn.disabled = false;
                btnText.textContent = 'Entrar com Google';
                googleIcon.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>

</html>